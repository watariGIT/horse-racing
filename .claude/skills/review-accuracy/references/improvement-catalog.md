# Improvement Catalog

モデル精度改善のアイデアカタログ。各アイデアに対象指標・期待効果・実装規模を付記。

## Priority Assignment Guide

| 優先度 | 基準 | 期待効果 |
|--------|------|----------|
| P0 | Poor 指標の修正、モデリング上の欠陥修正 | 主要指標 +5% 以上 |
| P1 | Acceptable → Good への改善、安定性向上 | 主要指標 +2-5% |
| P2 | インクリメンタル改善、既存データ活用の新特徴量 | 主要指標 +1-2% |
| P3 | 実験的アイデア、効果不明 | PR コメントのみ（Issue 不要） |

## 1. Feature Engineering（特徴量エンジニアリング）

### 1.1 調教師特徴量
- **内容**: 調教師の勝率、トップ3率、出走頭数
- **データ**: `_COLUMN_MAP_JA` に `trainer` カラムあり。`jockey_results_raw` と同様のパターンで集計可能
- **対象指標**: win_accuracy, auc_roc
- **期待効果**: +1-3%（調教師の影響は騎手と同等レベル）
- **実装規模**: Medium（新 extractor `trainer_features.py` + DataPreparer 修正）

### 1.2 コース別馬成績（horse × course 交互作用）
- **内容**: 各馬の特定コース（競馬場 × 芝/ダート）での過去成績
- **データ**: `race_id` から競馬場を抽出、`track_type` と組み合わせ
- **対象指標**: win_accuracy, ndcg
- **期待効果**: +1-2%（コース適性は予測に重要な要素）
- **実装規模**: Medium（DataPreparer でのグループ集計追加）

### 1.3 距離別馬成績（horse × distance band 交互作用）
- **内容**: 各馬の距離帯（短距離/マイル/中距離/長距離）別の過去成績
- **データ**: `distance` を 4 区分にビニング、馬ごとに距離帯別勝率を算出
- **対象指標**: win_accuracy, ndcg
- **期待効果**: +1-2%（距離適性も重要な要素）
- **実装規模**: Medium

### 1.4 賞金特徴量
- **内容**: 累計獲得賞金、直近N走の平均賞金、賞金トレンド（上昇/下降）
- **データ**: `prize` カラム（`_COLUMN_MAP_JA` で利用可能）
- **対象指標**: auc_roc, ndcg
- **期待効果**: +1-2%（賞金は馬の実力の間接指標）
- **実装規模**: Small（DataPreparer で rolling 集計追加）

### 1.5 馬体重変化トレンド
- **内容**: 前走比の体重変化量、直近3走の体重変化方向、適正体重からの乖離
- **データ**: `horse_weight` カラム（既に利用中だが変化量は未使用）
- **対象指標**: win_accuracy
- **期待効果**: +0.5-1%（体重変化は調子の指標）
- **実装規模**: Small

### 1.6 レースペース特徴量
- **内容**: レース全体のコーナー通過順位分布から推定するペース（ハイペース/ミドル/スロー）
- **データ**: `corner_positions` カラム（既存の running_style_features で一部利用）
- **対象指標**: win_accuracy, ndcg
- **期待効果**: +1-2%（ペースは展開に直結）
- **実装規模**: Medium（race 単位の集計が必要）
- **注意**: リーケージに注意。当該レースのペースではなく、出走馬の過去の脚質傾向から予測ペースを推定する

### 1.7 出走メンバー強度
- **内容**: 同レース内の競合馬の平均勝率・平均オッズから推定するレースレベル
- **データ**: 同一 race_id の全出走馬データ
- **対象指標**: win_accuracy, place_accuracy
- **期待効果**: +1-2%（相対的な実力差の把握）
- **実装規模**: Medium（race 単位のクロス集計が必要）
- **注意**: リーケージに注意。各馬の「当レース除く」過去成績を使うこと

### 1.8 季節・月特徴量
- **内容**: レース月のサイクリックエンコーディング（sin/cos）
- **データ**: `race_date` から月を抽出
- **対象指標**: auc_roc（季節性の捕捉）
- **期待効果**: +0.5-1%（競馬には季節パターンがある）
- **実装規模**: Small

### 1.9 休養期間の非線形エンコーディング
- **内容**: 前走からの日数を区間分け（短期休養/通常間隔/長期休明け）+ 非線形変換
- **データ**: `race_date` の差分（DataPreparer で算出可能）
- **対象指標**: win_accuracy
- **期待効果**: +0.5-1%（休養の影響は非線形）
- **実装規模**: Small

## 2. Model Architecture（モデルアーキテクチャ）

### 2.1 LambdaRank（LightGBM Ranker）
- **内容**: 分類問題ではなくランキング問題として定式化。LightGBM の `lambdarank` objective を使用
- **対象指標**: ndcg, ndcg_at_3, top3_accuracy
- **期待効果**: NDCG +3-5%（ランキング最適化に直接的）
- **実装規模**: Medium（`lgbm_ranker.py` が既に存在する可能性あり。group 定義が必要）

### 2.2 分類器 + ランカーのアンサンブル
- **内容**: LightGBM Classifier と Ranker の予測を重み付き平均で統合
- **対象指標**: 全指標（分類精度とランキング品質の両立）
- **期待効果**: +2-3%（多様なモデルの統合による安定性向上）
- **実装規模**: Large

### 2.3 確率キャリブレーション
- **内容**: Platt scaling または isotonic regression で予測確率を補正
- **対象指標**: log_loss, win_accuracy（確率ベースの閾値判定時）
- **期待効果**: log_loss 大幅改善、win_accuracy +1-2%
- **実装規模**: Small（sklearn の CalibratedClassifierCV を利用）
- **特に有効**: Cross-metric Pattern 1（High AUC + Low Accuracy）の場合

### 2.4 ハイパーパラメータチューニング最適化
- **内容**: 現在のハイパーパラメータ設定の見直し。Optuna / Hyperopt による探索
- **対象指標**: 全指標
- **期待効果**: +1-3%（現設定が最適でない場合）
- **実装規模**: Medium（`tuner.py` の活用・拡張）

## 3. Data Quality（データ品質）

### 3.1 少頭数レースの除外
- **内容**: 5頭以下のレースを学習・評価から除外
- **対象指標**: 全指標（ノイズ除去による指標安定化）
- **期待効果**: 安定性改善（CV 低減）、精度 +0.5-1%
- **実装規模**: Small（DataPreparer のフィルタ追加）

### 3.2 欠損値処理の改善
- **内容**: 現在の `None` フォールバックを改善。カテゴリ別の中央値/最頻値での補完
- **対象指標**: auc_roc, f1
- **期待効果**: +0.5-1%
- **実装規模**: Small

### 3.3 時間重み付き学習
- **内容**: LightGBM の sample_weight で最近のデータに高ウェイトを付与
- **対象指標**: 全指標（特に安定性・劣化傾向の改善）
- **期待効果**: 安定性改善、直近期間の精度 +1-2%
- **実装規模**: Small
- **特に有効**: Cross-metric Pattern 5（劣化傾向）の場合

## 4. Evaluation（評価手法）

### 4.1 Expanding vs Rolling Window 比較
- **内容**: 現在の rolling window に加えて expanding window でもバックテストし比較
- **対象指標**: 全指標の安定性評価
- **期待効果**: 最適な学習窓の特定による精度向上
- **実装規模**: Small（BacktestEngine の `train_window_days=None` で expanding mode 対応済み）

### 4.2 レースタイプ別層別分析
- **内容**: 芝/ダート、距離帯、グレード別にメトリクスを層別集計
- **対象指標**: 弱点レースタイプの特定
- **期待効果**: 改善ポイントの精密な特定（直接的な精度向上ではない）
- **実装規模**: Medium（Reporter の拡張）

## Selection Guide

改善提案の選択指針:

1. **Poor 指標がある場合**: その指標を対象とするアイデアから優先的に選択（P0-P1）
2. **安定性に問題がある場合**: 3.1（少頭数除外）、3.3（時間重み付き）を優先
3. **特徴量重要度に偏りがある場合**: 偏りを緩和する新特徴量を提案
4. **Cross-metric 矛盾がある場合**: 該当パターンの対策を優先
5. **全般的に Acceptable の場合**: 実装コストの小さいものから提案（P2）
6. **既に Good が多い場合**: 実験的アイデアを P3 として提案
